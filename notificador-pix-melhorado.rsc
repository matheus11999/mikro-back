:global pixMacsNotificar; :global pixAcaoNotificar; :log info "Notificador iniciado"; :log info "MACs: $pixMacsNotificar"; :log info "Acao: $pixAcaoNotificar"; :local url "https://api.lucro.top/api/mikrotik/auth-notification"; :local pos 0; :local totalSucesso 0; :local totalMacs 0; :while ([:find $pixMacsNotificar ";" $pos] >= 0) do={ :local fim [:find $pixMacsNotificar ";" $pos]; :local mac [:pick $pixMacsNotificar $pos $fim]; :if ([:len $mac] > 0) do={ :set totalMacs ($totalMacs + 1); :log info "Processando: $mac"; :local data "{\"token\":\"mtk_241ca9a5_cb1f8255\",\"mac_address\":\"$mac\",\"mikrotik_id\":\"78957cd3-7096-4acd-970b-0aa0a768c555\",\"action\":\"$pixAcaoNotificar\"}"; :local tentativas 0; :local enviado false; :while ($tentativas < 3 and !$enviado) do={ :set tentativas ($tentativas + 1); :log info "Tentativa $tentativas para: $mac"; :do { /tool fetch url=$url http-method=post http-header-field="Content-Type: application/json" http-data=$data keep-result=no timeout=(3 + $tentativas); :set enviado true; :set totalSucesso ($totalSucesso + 1); :log info "Sucesso: $mac (tentativa $tentativas)" } on-error={ :log warning "Erro tentativa $tentativas: $mac"; :if ($tentativas < 3) do={ :delay 2s } } }; :if (!$enviado) do={ :log error "Falha total: $mac apos 3 tentativas" } }; :set pos ($fim + 1) }; :log info "Resultado: $totalSucesso de $totalMacs enviados"; :if ($totalSucesso = $totalMacs and $totalMacs > 0) do={ :set pixMacsNotificar; :set pixAcaoNotificar; :log info "Todas notificacoes enviadas - variaveis limpas" } else={ :log warning "Nem todas notificacoes foram enviadas - variaveis mantidas" }; :log info "Finalizado" 