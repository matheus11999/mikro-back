:global pixMacsNotificar; :global pixAcaoNotificar; :log info "Notificador iniciado"; :log info "MACs: $pixMacsNotificar"; :log info "Acao: $pixAcaoNotificar"; :local url "https://api.lucro.top/api/mikrotik/auth-notification"; :local pos 0; :local sucessos 0; :local total 0; :while ([:find $pixMacsNotificar ";" $pos] >= 0) do={ :local fim [:find $pixMacsNotificar ";" $pos]; :local mac [:pick $pixMacsNotificar $pos $fim]; :if ([:len $mac] > 0) do={ :set total ($total + 1); :log info "Processando: $mac"; :local data "{\"token\":\"mtk_241ca9a5_cb1f8255\",\"mac_address\":\"$mac\",\"mikrotik_id\":\"78957cd3-7096-4acd-970b-0aa0a768c555\",\"action\":\"$pixAcaoNotificar\"}"; :local tentativa 1; :local enviado false; :while ($tentativa <= 3 and !$enviado) do={ :log info "Tentativa $tentativa: $mac"; :do { /tool fetch url=$url http-method=post http-header-field="Content-Type: application/json" http-data=$data keep-result=no; :set enviado true; :set sucessos ($sucessos + 1); :log info "Sucesso: $mac" } on-error={ :log error "Erro tentativa $tentativa: $mac"; :set tentativa ($tentativa + 1); :if ($tentativa <= 3) do={ :delay 1s } } }; :if (!$enviado) do={ :log error "Falha total: $mac" } }; :set pos ($fim + 1) }; :if ($sucessos = $total and $total > 0) do={ :set pixMacsNotificar; :set pixAcaoNotificar; :log info "Todas enviadas - variaveis limpas ($sucessos/$total)" } else={ :log warning "Falhas detectadas - variaveis mantidas ($sucessos/$total)" }; :log info "Finalizado" 