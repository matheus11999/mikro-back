:global pixMacsDesconectar; :log info "Notificador desconectado iniciado"; :log info "MACs: $pixMacsDesconectar"; :local url "https://api.lucro.top/api/mikrotik/auth-notification"; :local pos 0; :local sucessos 0; :local total 0; :while ([:find $pixMacsDesconectar ";" $pos] >= 0) do={ :local fim [:find $pixMacsDesconectar ";" $pos]; :local mac [:pick $pixMacsDesconectar $pos $fim]; :if ([:len $mac] > 0) do={ :set total ($total + 1); :log info "Processando desconexao: $mac"; :local data "{\"token\":\"mtk_241ca9a5_cb1f8255\",\"mac_address\":\"$mac\",\"mikrotik_id\":\"78957cd3-7096-4acd-970b-0aa0a768c555\",\"action\":\"disconnect\"}"; :local tentativa 1; :local enviado false; :while ($tentativa <= 3 and !$enviado) do={ :log info "Tentativa $tentativa desconexao: $mac"; :do { /tool fetch url=$url http-method=post http-header-field="Content-Type: application/json" http-data=$data keep-result=no; :set enviado true; :set sucessos ($sucessos + 1); :log info "Sucesso desconexao: $mac" } on-error={ :log error "Erro tentativa $tentativa desconexao: $mac"; :set tentativa ($tentativa + 1); :if ($tentativa <= 3) do={ :delay 1s } } }; :if (!$enviado) do={ :log error "Falha total desconexao: $mac" } }; :set pos ($fim + 1) }; :if ($sucessos = $total and $total > 0) do={ :set pixMacsDesconectar; :log info "Todas desconexoes enviadas - variavel limpa ($sucessos/$total)" } else={ :log warning "Falhas detectadas - variavel mantida ($sucessos/$total)" }; :log info "Notificador desconectado finalizado" 