/system script add name="pix-verificador" source=":local apiUrl \"https://api.lucro.top/api/recent-sales\"; :local mikrotikId \"78957cd3-7096-4acd-970b-0aa0a768c555\"; :local apiToken \"mtk_241ca9a5_cb1f8255\"; :log info \"PIX iniciado\"; :local macs \"\"; :for tentativa from=1 to=5 do={ :log info \"Tentativa \$tentativa\"; :local jsonData \"{\\\"mikrotik_id\\\\":\\\"\$mikrotikId\\\\",\\\\"token\\\\":\\\"\$apiToken\\\\\"}\"; /tool fetch url=\$apiUrl http-method=post http-header-field=\"Content-Type:application/json\" http-data=\$jsonData dst-path=\"vendas.txt\"; :delay 2s; :local vendas [/file get [find name=\"vendas.txt\"] contents]; /file remove [find name=\"vendas.txt\"]; :if ([:len \$vendas] > 0) do={ :local pos [:find \$vendas \"-\"]; :if (\$pos >= 0) do={ :local mac [:pick \$vendas 0 \$pos]; :local minutos [:tonum [:pick \$vendas (\$pos + 1) [:len \$vendas]]]; :log info \"MAC: \$mac, Min: \$minutos\"; :if ([:find \$macs \$mac] < 0) do={ :do { /ip hotspot ip-binding remove [find mac-address=\$mac] } on-error={}; :local agora [/system clock get time]; :local h [:tonum [:pick \$agora 0 2]]; :local m [:tonum [:pick \$agora 3 5]]; :local novoMin ((\$h * 60) + \$m + \$minutos); :local novaH (\$novoMin / 60); :local novaM (\$novoMin % 60); :if (\$novaH >= 24) do={ :set novaH (\$novaH - 24) }; :local hs [:tostr \$novaH]; :local ms [:tostr \$novaM]; :if ([:len \$hs] = 1) do={ :set hs (\"0\" . \$hs) }; :if ([:len \$ms] = 1) do={ :set ms (\"0\" . \$ms) }; :local dataExpire ([/system clock get date] . \"-\" . \$hs . \$ms); :local comentario (\"PIX-EXPIRE-\" . \$dataExpire . \"-\" . \$mac); /ip hotspot ip-binding add mac-address=\$mac type=bypassed comment=\$comentario; :log info \"Binding criado: \$mac\"; :set macs (\$macs . \$mac . \";\") } } } }; :if ([:len \$macs] > 0) do={ :global pixMacsNotificar \$macs; :global pixAcaoNotificar \"connect\"; :log info \"Executando notificador...\"; /system script run notificador-pix } else={ :log info \"Nenhum MAC processado\" }; :log info \"PIX concluido\"" 